---
title: "Pan Cancer MK2 Survival Analysis"
author: "Karthik Suresh"
date: "3/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(survminer)
library(survival)
library(dplyr)
library(tidyr)
#rm(list=ls())

MK2_data <- read.csv("../rawdata/MasterMK2data.csv", sep="\t")

# A quick check to make sure everything got joined properly
table(MK2_data$cancer.type.x, MK2_data$cancer.type.y)

MK2_data$time <- mapply(function(x,y) if(is.na(x)) return(y) else return(x), MK2_data$days_to_death, MK2_data$days_to_last_follow_up) 
MK2_data$time <- as.numeric(MK2_data$time)
MK2_data$age_at_diagnosis <- MK2_data$age_at_diagnosis/365
MK2_data$race <- as.factor(MK2_data$race)
MK2_data$smoking <- lapply(MK2_data$cigarettes_per_day, function(x) if(!is.na(x)) return(1) else return(0))
MK2_data$smoking <- as.factor(unlist(MK2_data$smoking))
MK2_data$tumor_stage <- as.factor(MK2_data$tumor_stage)
MK2_data$vital_status <- as.factor(MK2_data$vital_status)
MK2_data$status <- lapply(MK2_data$vital_status, function(x) if(x=="alive") return(0) else return(1))
MK2_data$status <- as.factor(unlist(MK2_data$status))
MK2_data$censor <- lapply(MK2_data$vital_status, function(x) if(x=="Alive") return(0) else return(1))
MK2_data$censor <- as.numeric(MK2_data$censor)

# combine stages
combineStage <- function(x) {
if(!is.na(x))  {
if(x=="Stage I" | x=="Stage IB" | x=="Stage IA") return("Early Stage")
if(x=="Stage II" | x=="Stage IIA" | x=="Stage IIB" | x=="Stage IIC") return("Early Stage")
if(x=="Stage IIIA" | x=="Stage III" | x=="Stage IIIB" | x=="Stage IIIC") return("Late Stage")
if(x=="Stage IV" | x=="Stage IVA" | x=="Stage IVB" ) return("Late Stage")
}
  
}
MK2_data$ajcc_pathologic_stage_combined <- lapply(MK2_data$ajcc_pathologic_stage, combineStage)
MK2_data$ajcc_pathologic_stage_combined <- as.factor(as.character(MK2_data$ajcc_pathologic_stage_combined))

# how many patients were left out (i.e. combined stage == "NULL") by the classifier above
table(MK2_data[MK2_data$ajcc_pathologic_stage_combined=="NULL",]$ajcc_pathologic_stage)

# we lose a lot more than the  few unclassified here because ~ 2000 cases are "NA" for ajcc pathologic stage. 
MK2_data <- MK2_data[MK2_data$ajcc_pathologic_stage_combined!="NULL",]
MK2_data$ajcc_pathologic_stage_combined <- as.factor(as.character(MK2_data$ajcc_pathologic_stage_combined))
ggplot(MK2_data[MK2_data$ajcc_pathologic_stage_combined!="NULL",], aes(fill=ajcc_pathologic_stage_combined, y=as.numeric(Expression), x=cancer.type.x))+geom_boxplot()+theme_bw()


MK2_means <- aggregate(Expression~ajcc_pathologic_stage_combined+cancer.type.x, data=MK2_data, FUN=mean) 
MK2_means_wide <- spread(MK2_means, ajcc_pathologic_stage_combined, Expression)
MK2_means_wide$diff <- MK2_means_wide$`Early Stage`-MK2_means_wide$`Late Stage`
ggplot(MK2_means_wide, aes(x=reorder(cancer.type.x,-diff),y=diff))+geom_col()+theme_bw()+ylab("Difference in mean MK2 transcript level between Early and Late Stage disease")+xlab("Cancer Type")+coord_flip()

```
# Create MK2 categories (low vs. high)
An added issue here is that we need to define quantiles WITHIN tumor groups. So the quantile for each tumor group is different. 
```{r}
MK2_data <- MK2_data[!is.na(MK2_data$Expression),]
# create MK2 quantiles 
bottom_quant <<- 0.33
top_quant <<- 0.66

BelowBottomQuantile <- function(cancer.type, x){
   if(x < quantile(MK2_data[MK2_data$cancer.type.x==cancer.type,]$Expression, bottom_quant)) return(1) 
  else return(0) 
     }
AboveTopQuantile <- function(cancer.type, x){
   if(x > quantile(MK2_data[MK2_data$cancer.type.x==cancer.type,]$Expression, top_quant)) return(1) 
  else return(0) 
}
MK2_data$MK2_Expression_bottomQ <- mapply(BelowBottomQuantile, MK2_data$cancer.type.x, MK2_data$Expression)
MK2_data$MK2_Expression_topQ <- mapply(AboveTopQuantile, MK2_data$cancer.type.x, MK2_data$Expression)


MK2_data_tb <- MK2_data[MK2_data$MK2_Expression_bottomQ ==1 | MK2_data$MK2_Expression_topQ==1,]
MK2_data_tb$MK2_Expression_topQ <- as.numeric(MK2_data_tb$MK2_Expression_topQ)
MK2_data_tb$MK2_Expression_bottomQ <- as.numeric(MK2_data_tb$MK2_Expression_bottomQ)

# re-categorize the variable as MK2_tv where 0 = lower 10th, 1= top 10th
MK2_data_tb$MK2_tv <- mapply(function(bottomQ, topQ) if(bottomQ==1) return("Low") else return("High"), MK2_data_tb$MK2_Expression_bottomQ, MK2_data_tb$MK2_Expression_topQ)
MK2_data_tb$MK2_tv <- as.factor(MK2_data_tb$MK2_tv)
```

# Collect Cox PH info
```{r}
# reporoduce the LUAD findings

MK2_tvary_LUAD <- survSplit(Surv(time, censor) ~ ., data=MK2_data_tb[MK2_data_tb$cancer.type.x=="LUAD",], cut=c(365,600,1000), episode="tgroup", zero=0)
MK2_tvary_LUAD_model <- coxph(Surv(tstart,time, censor)~MK2_tv:strata(tgroup):strata(ajcc_pathologic_stage_combined), data=MK2_tvary_LUAD)
summary(MK2_tvary_LUAD_model)

# yay! we get the same point estimate. 

# now we do this for all cancers.

returnModel <- function (cancer.type) {
MK2_tvary <- survSplit(Surv(time, censor) ~ ., data=MK2_data_tb[MK2_data_tb$cancer.type.x==cancer.type & MK2_data_tb$time > 0,], cut=c(365,600,1000), episode="tgroup", zero=0)

MK2_tvary_model <- coxph(Surv(tstart,time, censor)~MK2_tv:strata(tgroup):strata(ajcc_pathologic_stage_combined), data=MK2_tvary)

return(MK2_tvary_model)

}

MK2_model_df <- MK2_means_wide

MK2_model_df$model1.results <- lapply(MK2_model_df$cancer.type.x, returnModel)
MK2_model_df$t1early <- lapply(MK2_model_df$model1.results, function(x) return(x$coefficients[[1]][1]))
MK2_model_df$t1early.lci <- lapply(MK2_model_df$model1.results, function(x) return(exp(confint(x)[1])))
MK2_model_df$t1early.uci <- lapply(MK2_model_df$model1.results, function(x) return(exp(confint(x)[17])))

MK2_model_df$t1early.lci <- as.numeric(MK2_model_df$t1early.lci)
MK2_model_df$t1early.uci <- as.numeric(MK2_model_df$t1early.uci)

MK2_model_df$t2early <- lapply(MK2_model_df$model1.results, function(x) return(x$coefficients[[3]][1]))
MK2_model_df$t2early.lci <- lapply(MK2_model_df$model1.results, function(x) return(exp(confint(x)[3])))
MK2_model_df$t2early.uci <- lapply(MK2_model_df$model1.results, function(x) return(exp(confint(x)[19])))

MK2_model_df$t3early <- lapply(MK2_model_df$model1.results, function(x) return(x$coefficients[[5]][1]))
MK2_model_df$t3early.lci <- lapply(MK2_model_df$model1.results, function(x) return(exp(confint(x)[5])))
MK2_model_df$t3early.uci <- lapply(MK2_model_df$model1.results, function(x) return(exp(confint(x)[21])))

MK2_model_df$t4early <- lapply(MK2_model_df$model1.results, function(x) return(x$coefficients[[7]][1]))
MK2_model_df$t4early.lci <- lapply(MK2_model_df$model1.results, function(x) return(exp(confint(x)[7])))
MK2_model_df$t4early.uci <- lapply(MK2_model_df$model1.results, function(x) return(exp(confint(x)[23])))

MK2_model_df_long <- gather(MK2_model_df, key="timepoint", value="HR", t1early, t2early, t3early, t4early)

ggplot(MK2_model_df_long, aes(x=as.factor(timepoint), y=as.numeric(HR)))+geom_point()+geom_line()+facet_wrap(~cancer.type.x, scales = "free")

ggplot(MK2_model_df, aes(x=cancer.type.x,y=as.numeric(t1early)))+geom_point()+geom_errorbar(aes(ymin=t1early.lci, ymax=t1early.uci), width=0)+geom_hline(yintercept = 1)+theme_bw()

ggplot(MK2_model_df, aes(x=cancer.type.x,y=as.numeric(t1early)))+geom_point()+geom_errorbar(aes(ymin=t1early.lci, ymax=t1early.uci), width=0)+ylim(-1,2)+geom_hline(yintercept = 1)+theme_bw()

ggplot(MK2_model_df, aes(x=reorder(cancer.type.x, -as.numeric(t1early)),y=as.numeric(t1early)))+geom_bar(stat="identity")+geom_hline(yintercept = 1)+theme_bw()

ggplot(MK2_model_df, aes(x=reorder(cancer.type.x, -diff),y=diff))+geom_bar(stat="identity")+theme_bw()+coord_flip()+ ylab("Difference in mean MK2 transcript level between early and late stage cancer")+xlab("TCGA Cancer dataset")


# get rid of large CIs
MK2_model_df_trimmed <- MK2_model_df[MK2_model_df$t1early.uci < 10 & !is.na(MK2_model_df$t1early.uci), ]

ggplot(MK2_model_df_trimmed, aes(x=cancer.type.x,y=exp(as.numeric(t1early))))+geom_point()+geom_errorbar(aes(ymin=t1early.lci, ymax=t1early.uci), width=0)+geom_hline(yintercept = 1)+theme_bw()+coord_flip()+ylab("HR for survival at 1 year for high MK2 transcript level")+xlab("Cancer dataset")

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
